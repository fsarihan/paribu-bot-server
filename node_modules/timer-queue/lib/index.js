"use strict";

var _events = require("events");

var _sleepPromise = _interopRequireDefault(require("sleep-promise"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _createSuper(Derived) { return function () { var Super = _getPrototypeOf(Derived), result; if (_isNativeReflectConstruct()) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

var defaultParams = {
  timeout: 0,
  interval: 0,
  retry: 0,
  retryInterval: 0,
  autoStart: false,
  startImmediately: false
};

var _next = Symbol('_next');

var _end = Symbol('_end');

var _error = Symbol('_error');

var _isRunning = Symbol('_isRunning');

var _isError = Symbol('_isError');

var isPromise = function isPromise(obj) {
  return !!obj && (_typeof(obj) === 'object' || typeof obj === 'function') && typeof obj.then === 'function';
};

var TimerQueue = /*#__PURE__*/function (_EventEmitter) {
  _inherits(TimerQueue, _EventEmitter);

  var _super = _createSuper(TimerQueue);

  function TimerQueue() {
    var _this;

    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

    _classCallCheck(this, TimerQueue);

    _this = _super.call(this);
    _this.queue = [];
    _this[_isRunning] = false;
    _this[_isError] = false;
    options = Object.assign({}, defaultParams, options);
    _this.timeout = options.timeout;
    _this.interval = options.interval;
    _this.retry = options.retry;
    _this.retryInterval = options.retryInterval;
    _this.autoStart = options.autoStart;
    _this.startImmediately = options.startImmediately;
    return _this;
  }

  _createClass(TimerQueue, [{
    key: "push",
    value: function push(fn) {
      var params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;

      if (typeof fn !== 'function') {
        throw new TypeError('first argument must be a function');
      }

      if (typeof params === 'number') {
        params = {
          delay: params
        };
      }

      var isStartingWithEmptyQueue = this.queue.length === 0;
      this.queue.push(Object.assign({}, params, {
        fn: fn
      }));

      if (this.autoStart) {
        this.start({
          isStartingWithEmptyQueue: isStartingWithEmptyQueue
        });
      }

      return this;
    }
  }, {
    key: "start",
    value: function start() {
      var _this2 = this;

      var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
          _ref$isStartingWithEm = _ref.isStartingWithEmptyQueue,
          isStartingWithEmptyQueue = _ref$isStartingWithEm === void 0 ? true : _ref$isStartingWithEm;

      if (this[_isRunning]) {
        return;
      }

      if (this.queue.length <= 0) {
        this[_end]();

        return;
      }

      this[_isRunning] = true;
      this[_isError] = false;
      var runImmediately = this.startImmediately && (this.autoStart && this.queue.length === 1 && isStartingWithEmptyQueue || !this.autoStart && isStartingWithEmptyQueue);

      var _this$queue$shift = this.queue.shift(),
          fn = _this$queue$shift.fn,
          _this$queue$shift$del = _this$queue$shift.delay,
          delay = _this$queue$shift$del === void 0 ? 0 : _this$queue$shift$del,
          _this$queue$shift$ret = _this$queue$shift.retry,
          retry = _this$queue$shift$ret === void 0 ? this.retry : _this$queue$shift$ret,
          _this$queue$shift$ret2 = _this$queue$shift.retryInterval,
          retryInterval = _this$queue$shift$ret2 === void 0 ? this.retryInterval : _this$queue$shift$ret2,
          _this$queue$shift$ret3 = _this$queue$shift.retryCount,
          retryCount = _this$queue$shift$ret3 === void 0 ? 0 : _this$queue$shift$ret3,
          _this$queue$shift$err = _this$queue$shift.error,
          error = _this$queue$shift$err === void 0 ? function () {} : _this$queue$shift$err;

      var delayToUse = runImmediately ? 0 : delay;
      return (0, _sleepPromise["default"])(delayToUse).then(function () {
        var promises = [];
        var sync = fn && fn.length;

        if (sync) {
          promises.push(new Promise(function (resolve, reject) {
            fn.call(_this2, resolve, reject);
          }));
        } else {
          var result = fn.call(_this2);

          if (isPromise(result)) {
            promises.push(result);
          } else if (result === false) {
            promises.push(Promise.reject(new Error('return false')));
          } else {
            promises.push(Promise.resolve());
          }
        }

        if (_this2.timeout > 0) {
          promises.push((0, _sleepPromise["default"])(_this2.timeout).then(function () {
            return Promise.reject(new Error('timeout'));
          }));
        }

        Promise.race(promises)["catch"](function (e) {
          if (retryCount < retry) {
            _this2.queue.unshift({
              fn: fn,
              delay: delay,
              retry: retry,
              retryInterval: retryInterval,
              retryCount: retryCount + 1,
              error: error
            });

            return Promise.resolve(retryInterval);
          } else {
            return Promise.reject(e || new Error('error'));
          }
        }).then(function (interval) {
          _this2[_next](interval);
        })["catch"](function (e) {
          error.call(_this2, e);

          _this2[_error](e);
        });
      });
    }
  }, {
    key: "stop",
    value: function stop() {
      this[_isRunning] = false;
    }
  }, {
    key: "clear",
    value: function clear() {
      this.queue.length = 0;
    }
  }, {
    key: _next,
    value: function value() {
      var _this3 = this;

      var interval = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.interval;

      if (this[_isRunning] && this.queue.length) {
        (0, _sleepPromise["default"])(interval).then(function () {
          _this3[_isRunning] = false;

          _this3.start({
            isStartingWithEmptyQueue: false
          });
        });
      } else {
        this[_end]();
      }
    }
  }, {
    key: _end,
    value: function value() {
      this[_isRunning] = false;
      this[_isError] = false;

      if (this.listenerCount('end') > 0) {
        this.emit('end');
      }
    }
  }, {
    key: _error,
    value: function value(err) {
      this[_isRunning] = false;
      this[_isError] = true;

      if (this.listenerCount('error') > 0) {
        this.emit('error', err);
      }
    }
  }, {
    key: "isRunning",
    get: function get() {
      return this[_isRunning];
    }
  }, {
    key: "isFailed",
    get: function get() {
      return this[_isError];
    }
  }]);

  return TimerQueue;
}(_events.EventEmitter);

module.exports = TimerQueue;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJkZWZhdWx0UGFyYW1zIiwidGltZW91dCIsImludGVydmFsIiwicmV0cnkiLCJyZXRyeUludGVydmFsIiwiYXV0b1N0YXJ0Iiwic3RhcnRJbW1lZGlhdGVseSIsIl9uZXh0IiwiU3ltYm9sIiwiX2VuZCIsIl9lcnJvciIsIl9pc1J1bm5pbmciLCJfaXNFcnJvciIsImlzUHJvbWlzZSIsIm9iaiIsInRoZW4iLCJUaW1lclF1ZXVlIiwib3B0aW9ucyIsInF1ZXVlIiwiT2JqZWN0IiwiYXNzaWduIiwiZm4iLCJwYXJhbXMiLCJUeXBlRXJyb3IiLCJkZWxheSIsImlzU3RhcnRpbmdXaXRoRW1wdHlRdWV1ZSIsImxlbmd0aCIsInB1c2giLCJzdGFydCIsInJ1bkltbWVkaWF0ZWx5Iiwic2hpZnQiLCJyZXRyeUNvdW50IiwiZXJyb3IiLCJkZWxheVRvVXNlIiwicHJvbWlzZXMiLCJzeW5jIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJjYWxsIiwicmVzdWx0IiwiRXJyb3IiLCJyYWNlIiwiZSIsInVuc2hpZnQiLCJsaXN0ZW5lckNvdW50IiwiZW1pdCIsImVyciIsIkV2ZW50RW1pdHRlciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsYUFBYSxHQUFHO0FBQ3BCQyxFQUFBQSxPQUFPLEVBQUUsQ0FEVztBQUVwQkMsRUFBQUEsUUFBUSxFQUFFLENBRlU7QUFHcEJDLEVBQUFBLEtBQUssRUFBRSxDQUhhO0FBSXBCQyxFQUFBQSxhQUFhLEVBQUUsQ0FKSztBQUtwQkMsRUFBQUEsU0FBUyxFQUFFLEtBTFM7QUFNcEJDLEVBQUFBLGdCQUFnQixFQUFFO0FBTkUsQ0FBdEI7O0FBUUEsSUFBTUMsS0FBSyxHQUFHQyxNQUFNLENBQUMsT0FBRCxDQUFwQjs7QUFDQSxJQUFNQyxJQUFJLEdBQUdELE1BQU0sQ0FBQyxN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QyxFQUFxQztBQUNuQyxhQUFLQyxJQUFMLENBQVUsT0FBVixFQUFtQkMsR0FBbkI7QUFDRDtBQUNGOzs7d0JBakNnQjtBQUNmLGFBQU8sS0FBS3BDLFVBQUwsQ0FBUDtBQUNEOzs7d0JBRWU7QUFDZCxhQUFPLEtBQUtDLFFBQUwsQ0FBUDtBQUNEOzs7O0VBeEhzQm9DLG9COztBQXNKekJDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmxDLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJ1xuaW1wb3J0IHNsZWVwIGZyb20gJ3NsZWVwLXByb21pc2UnXG5cbmNvbnN0IGRlZmF1bHRQYXJhbXMgPSB7XG4gIHRpbWVvdXQ6IDAsXG4gIGludGVydmFsOiAwLFxuICByZXRyeTogMCxcbiAgcmV0cnlJbnRlcnZhbDogMCxcbiAgYXV0b1N0YXJ0OiBmYWxzZSxcbiAgc3RhcnRJbW1lZGlhdGVseTogZmFsc2Vcbn1cbmNvbnN0IF9uZXh0ID0gU3ltYm9sKCdfbmV4dCcpXG5jb25zdCBfZW5kID0gU3ltYm9sKCdfZW5kJylcbmNvbnN0IF9lcnJvciA9IFN5bWJvbCgnX2Vycm9yJylcbmNvbnN0IF9pc1J1bm5pbmcgPSBTeW1ib2woJ19pc1J1bm5pbmcnKVxuY29uc3QgX2lzRXJyb3IgPSBTeW1ib2woJ19pc0Vycm9yJylcblxuY29uc3QgaXNQcm9taXNlID0gKG9iaikgPT4ge1xuICByZXR1cm4gISFvYmogJiYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpICYmIHR5cGVvZiBvYmoudGhlbiA9PT0gJ2Z1bmN0aW9uJ1xufVxuXG5jbGFzcyBUaW1lclF1ZXVlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKG9wdGlvbnMgPSB7fSkge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLnF1ZXVlID0gW11cbiAgICB0aGlzW19pc1J1bm5pbmddID0gZmFsc2VcbiAgICB0aGlzW19pc0Vycm9yXSA9IGZhbHNlXG5cbiAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdFBhcmFtcywgb3B0aW9ucylcblxuICAgIHRoaXMudGltZW91dCA9IG9wdGlvbnMudGltZW91dFxuICAgIHRoaXMuaW50ZXJ2YWwgPSBvcHRpb25zLmludGVydmFsXG4gICAgdGhpcy5yZXRyeSA9IG9wdGlvbnMucmV0cnlcbiAgICB0aGlzLnJldHJ5SW50ZXJ2YWwgPSBvcHRpb25zLnJldHJ5SW50ZXJ2YWxcbiAgICB0aGlzLmF1dG9TdGFydCA9IG9wdGlvbnMuYXV0b1N0YXJ0XG4gICAgdGhpcy5zdGFydEltbWVkaWF0ZWx5ID0gb3B0aW9ucy5zdGFydEltbWVkaWF0ZWx5XG4gIH1cblxuICBwdXNoIChmbiwgcGFyYW1zID0gMCkge1xuICAgIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2ZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBmdW5jdGlvbicpXG4gICAgfVxuICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnbnVtYmVyJykge1xuICAgICAgcGFyYW1zID0geyBkZWxheTogcGFyYW1zIH1cbiAgICB9XG4gICAgY29uc3QgaXNTdGFydGluZ1dpdGhFbXB0eVF1ZXVlID0gdGhpcy5xdWV1ZS5sZW5ndGggPT09IDBcbiAgICB0aGlzLnF1ZXVlLnB1c2goT2JqZWN0LmFzc2lnbih7fSwgcGFyYW1zLCB7XG4gICAgICBmblxuICAgIH0pKVxuICAgIGlmICh0aGlzLmF1dG9TdGFydCkge1xuICAgICAgdGhpcy5zdGFydCh7IGlzU3RhcnRpbmdXaXRoRW1wdHlRdWV1ZSB9KVxuICAgIH1cbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgc3RhcnQgKHsgaXNTdGFydGluZ1dpdGhFbXB0eVF1ZXVlID0gdHJ1ZSB9ID0ge30pIHtcbiAgICBpZiAodGhpc1tfaXNSdW5uaW5nXSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGlmICh0aGlzLnF1ZXVlLmxlbmd0aCA8PSAwKSB7XG4gICAgICB0aGlzW19lbmRdKClcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICB0aGlzW19pc1J1bm5pbmddID0gdHJ1ZVxuICAgIHRoaXNbX2lzRXJyb3JdID0gZmFsc2VcblxuICAgIGNvbnN0IHJ1bkltbWVkaWF0ZWx5ID0gdGhpcy5zdGFydEltbWVkaWF0ZWx5ICYmXG4gICAgICAoXG4gICAgICAgICh0aGlzLmF1dG9TdGFydCAmJiB0aGlzLnF1ZXVlLmxlbmd0aCA9PT0gMSAmJiBpc1N0YXJ0aW5nV2l0aEVtcHR5UXVldWUpIHx8XG4gICAgICAgICghdGhpcy5hdXRvU3RhcnQgJiYgaXNTdGFydGluZ1dpdGhFbXB0eVF1ZXVlKVxuICAgICAgKVxuXG4gICAgY29uc3Qge1xuICAgICAgZm4sXG4gICAgICBkZWxheSA9IDAsXG4gICAgICByZXRyeSA9IHRoaXMucmV0cnksXG4gICAgICByZXRyeUludGVydmFsID0gdGhpcy5yZXRyeUludGVydmFsLFxuICAgICAgcmV0cnlDb3VudCA9IDAsXG4gICAgICBlcnJvciA9ICgpID0+IHt9XG4gICAgfSA9IHRoaXMucXVldWUuc2hpZnQoKVxuXG4gICAgY29uc3QgZGVsYXlUb1VzZSA9IHJ1bkltbWVkaWF0ZWx5ID8gMCA6IGRlbGF5XG4gICAgcmV0dXJuIHNsZWVwKGRlbGF5VG9Vc2UpLnRoZW4oKCkgPT4ge1xuICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXVxuICAgICAgY29uc3Qgc3luYyA9IGZuICYmIGZuLmxlbmd0aFxuICAgICAgaWYgKHN5bmMpIHtcbiAgICAgICAgcHJvbWlzZXMucHVzaChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgZm4uY2FsbCh0aGlzLCByZXNvbHZlLCByZWplY3QpXG4gICAgICAgIH0pKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gZm4uY2FsbCh0aGlzKVxuICAgICAgICBpZiAoaXNQcm9taXNlKHJlc3VsdCkpIHtcbiAgICAgICAgICBwcm9taXNlcy5wdXNoKHJlc3VsdClcbiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7XG4gICAgICAgICAgcHJvbWlzZXMucHVzaChQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ3JldHVybiBmYWxzZScpKSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwcm9taXNlcy5wdXNoKFByb21pc2UucmVzb2x2ZSgpKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAodGhpcy50aW1lb3V0ID4gMCkge1xuICAgICAgICBwcm9taXNlcy5wdXNoKHNsZWVwKHRoaXMudGltZW91dCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcigndGltZW91dCcpKVxuICAgICAgICB9KSlcbiAgICAgIH1cbiAgICAgIFByb21pc2UucmFjZShwcm9taXNlcykuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgaWYgKHJldHJ5Q291bnQgPCByZXRyeSkge1xuICAgICAgICAgIHRoaXMucXVldWUudW5zaGlmdCh7XG4gICAgICAgICAgICBmbixcbiAgICAgICAgICAgIGRlbGF5LFxuICAgICAgICAgICAgcmV0cnksXG4gICAgICAgICAgICByZXRyeUludGVydmFsLFxuICAgICAgICAgICAgcmV0cnlDb3VudDogcmV0cnlDb3VudCArIDEsXG4gICAgICAgICAgICBlcnJvclxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXRyeUludGVydmFsKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlIHx8IG5ldyBFcnJvcignZXJyb3InKSlcbiAgICAgICAgfVxuICAgICAgfSkudGhlbigoaW50ZXJ2YWwpID0+IHtcbiAgICAgICAgdGhpc1tfbmV4dF0oaW50ZXJ2YWwpXG4gICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICBlcnJvci5jYWxsKHRoaXMsIGUpXG4gICAgICAgIHRoaXNbX2Vycm9yXShlKVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgc3RvcCAoKSB7XG4gICAgdGhpc1tfaXNSdW5uaW5nXSA9IGZhbHNlXG4gIH1cblxuICBjbGVhciAoKSB7XG4gICAgdGhpcy5xdWV1ZS5sZW5ndGggPSAwXG4gIH1cblxuICBnZXQgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gdGhpc1tfaXNSdW5uaW5nXVxuICB9XG5cbiAgZ2V0IGlzRmFpbGVkICgpIHtcbiAgICByZXR1cm4gdGhpc1tfaXNFcnJvcl1cbiAgfVxuXG4gIFtfbmV4dF0gKGludGVydmFsID0gdGhpcy5pbnRlcnZhbCkge1xuICAgIGlmICh0aGlzW19pc1J1bm5pbmddICYmIHRoaXMucXVldWUubGVuZ3RoKSB7XG4gICAgICBzbGVlcChpbnRlcnZhbCkudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXNbX2lzUnVubmluZ10gPSBmYWxzZVxuICAgICAgICB0aGlzLnN0YXJ0KHsgaXNTdGFydGluZ1dpdGhFbXB0eVF1ZXVlOiBmYWxzZSB9KVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpc1tfZW5kXSgpXG4gICAgfVxuICB9XG5cbiAgW19lbmRdICgpIHtcbiAgICB0aGlzW19pc1J1bm5pbmddID0gZmFsc2VcbiAgICB0aGlzW19pc0Vycm9yXSA9IGZhbHNlXG4gICAgaWYgKHRoaXMubGlzdGVuZXJDb3VudCgnZW5kJykgPiAwKSB7XG4gICAgICB0aGlzLmVtaXQoJ2VuZCcpXG4gICAgfVxuICB9XG5cbiAgW19lcnJvcl0gKGVycikge1xuICAgIHRoaXNbX2lzUnVubmluZ10gPSBmYWxzZVxuICAgIHRoaXNbX2lzRXJyb3JdID0gdHJ1ZVxuICAgIGlmICh0aGlzLmxpc3RlbmVyQ291bnQoJ2Vycm9yJykgPiAwKSB7XG4gICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKVxuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFRpbWVyUXVldWVcbiJdfQ==